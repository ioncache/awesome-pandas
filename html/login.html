<head>
    <link rel="stylesheet" href="css/persona-buttons.css" />
<script>
var _ratchetParams = {"server.environment": "production"};
var _ratchet=["d3ac21376b0e414d9e4b66ce17a429f4", _ratchetParams];
(function(w,d){w.onerror=function(){_ratchet.push(arguments);};var i=function(){var s=d.createElement("script");var 
f=d.getElementsByTagName("script")[0];s.src="//d2tf6sbdgil6xr.cloudfront.net/js/11/ratchet.js";s.async=!0;
f.parentNode.insertBefore(s,f);};if(w.addEventListener){w.addEventListener("load",i,!1);}else{w.attachEvent("onload",i);}})(window,document);
</script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script src="https://login.persona.org/include.js"></script>
</head>
<script>
window.onload = function() {
    var room = 'USD_CAD';
    var socket = io.connect(location.origin);

    document.getElementById('signin').onclick = function(e) {
        navigator.id.request();
        e.preventDefault();
    };
    document.getElementById('signout').onclick = function(e) {
        navigator.id.logout();
        e.preventDefault();
    };

    navigator.id.watch({
        loggedInUser: null,
        onlogin: function(assertion) {
                console.log('========== onlogin', assertion);
                $.ajax({
                    type: 'POST',
                    url: '/auth/login',
                    data: {assertion: assertion},
                    success: function(response, status, xhr) {
                            console.log(response, status);
                            gravatar = response.gravatar;
                            username = response.username;

                            $('#signin-div').hide();
                            $('#signout-div').show();

                            socket.emit('adduser', username);
                        },
                    error: function(xhr, status, error) {
                            console.log(xhr, status, error);
                        }
                });
            },
        onlogout: function() {
                console.log('========== onlogout');
                $.ajax({
                    type: 'POST',
                    url: '/auth/logout',
                    success: function(response, status, xhr) {
                            console.log(response, status);

                            $('#signin-div').show();
                            $('#signout-div').hide();
                        },
                    error: function(xhr, status, error) {
                            console.log(xhr, status, error);
                        }
                });
            }
    });




    // on connection to server, ask for user's name with an anonymous callback
    socket.on('connect', function(){
        socket.emit('join', room);
    });

    socket.on('snapshot', function(data) {
        console.log(data);
    });

    // listener, whenever the server emits 'updatechat', this updates the chat body
    socket.on('updatechat', function (username, data) {
        $('#conversation').append('<b>'+username + ':</b> ' + data + '<br>');
    });

    // listener, whenever the server emits 'updateusers', this updates the username list
    socket.on('updateusers', function(data) {
        $('#users').empty();
        $.each(data, function(key, value) {
            $('#users').append('<div>' + key + '</div>');
        });
    });

    // on load of page
    $(function(){
        // when the client clicks SEND
        $('#datasend').click( function() {
            var message = $('#data').val();
            $('#data').val('');
            // tell server to execute 'sendchat' and send along one parameter
            socket.emit('sendchat', message);
        });

        // when the client hits ENTER on their keyboard
        $('#data').keypress(function(e) {
            if(e.which == 13) {
                $(this).blur();
//                $('#datasend').focus().click();
            }
        });
    });
};
</script>

<div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">
        <b>USERS</b>
        <div id="users"></div>
</div>
<div style="float:left;width:300px;height:250px;overflow:scroll-y;padding:10px;">
        <div id="conversation"></div>
        <div id="signin-div">
            <a id="signin" href="#" class="persona-button"><span>Sign in with your Email</span></a>
        </div>
        <div id="signout-div" style="display: none;">
            <input id="data" style="width:200px;" />
            <input type="button" id="datasend" value="send" />
            <a id="signout" href="#" class="persona-button"><span>Sign out</span></a>
        </div>
</div>
