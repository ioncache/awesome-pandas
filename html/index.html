<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Forex Chart Chat</title>
        <meta name="author" content="Awesome Pandas"/>
        <meta name="description" content="">
        <meta name="keywords" content="" />
        <meta name="robots" content="index, nofollow">
        <meta name="viewport" content="width=device-width">
        
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
            
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/bootstrap-responsive.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/bootmetro.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/bootmetro-tiles.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/bootmetro-charms.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/metro-ui-light.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/icomoon.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/datepicker.css">
        <link rel="stylesheet" type="text/css" href="css/vendor/bootmetro/css/daterangepicker.css">
        <link rel="stylesheet" href="css/main.css">

        <link rel="shortcut icon" href="css/vendor/bootmetro/ico/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="css/vendor/bootmetro/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="css/vendor/bootmetro/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="css/vendor/bootmetro/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="css/vendor/bootmetro/ico/apple-touch-icon-57-precomposed.png">
        <link rel="stylesheet" href="css/persona-buttons.css" />

<script>
var _ratchetParams = {"server.environment": "production"};
var _ratchet=["d3ac21376b0e414d9e4b66ce17a429f4", _ratchetParams];
(function(w,d){w.onerror=function(){_ratchet.push(arguments);};var i=function(){var s=d.createElement("script");var 
f=d.getElementsByTagName("script")[0];s.src="//d2tf6sbdgil6xr.cloudfront.net/js/11/ratchet.js";s.async=!0;
f.parentNode.insertBefore(s,f);};if(w.addEventListener){w.addEventListener("load",i,!1);}else{w.attachEvent("onload",i);}})(window,document);
</script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        <script src="https://login.persona.org/include.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="#/"><span class="title_text">Chart Chat</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li id="home_page" class="menu_item active"><a href="#/">Charts</a></li>
                            <li id="profile_page" class="menu_item"><a href="#/leaderboard/1">Profile</a></li>
                        </ul>
                    </div>
                    <div id="user_info" class="pull-right" style="display: none; height: 41px; line-height: 41px; color: #9EBA91; cursor: pointer;">
                        Logged in as: <span data-bind="text: username"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrapper">
            <div class="container">
                <div id="chart" class="view" style="display: block; position: relative;">
                    <div id="chart_info" class="well" style="position: relative;">
                        <h1 class="align-center">
                            Chat about USD/CAD
                        </h1>
                    </div>
                    <div id="chart_container" class="row"></div>
                    <div id="chat" class="row">
                        <div class="span10">
                            <div class="row">
                            <div id="chat_container" class="row"></div>
                            <div id="login_prompt">
            <a id="signin" href="#" class="persona-button"><span>Sign in with your Email</span></a>
                            </div>
                            <div id="chat_prompt" class="row" style="display: none;">
                                <input id="message" class="pull-left span9" type="text" placeholder="Type your message..." />
                                <button id="send_message" class="pull-right btn btn-success" type="button">Send</button>
            <a id="signout" href="#" class="persona-button"><span>Sign out</span></a>
                            </div>
                            <div id="chat_container" class="row"></div>
                        </div>
                        <div class="span2">
                            <div class="label">Users in Room</div>
                            <div id="users"></div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        

        <!-- all javascript except for modernizr -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.2.min.js"><\/script>')</script>

        <script src="js/vendor/sammy-latest.min.js"></script>
        <script src="js/vendor/highcharts/highcharts.js"></script>
        <script src="js/vendor/highstock/highstock.js"></script>

        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>

        <script>
        var room = 'USD_CAD';
        var socket = io.connect(location.origin);
        var session_id;
        var series_data = [];
window.onload = function() {
    document.getElementById('signin').onclick = function(e) {
        navigator.id.request();
        e.preventDefault();
    };
    document.getElementById('signout').onclick = function(e) {
        navigator.id.logout();
        e.preventDefault();
    };

    navigator.id.watch({
        loggedInUser: null,
        onlogin: function(assertion) {
                console.log('========== onlogin', assertion);
                $.ajax({
                    type: 'POST',
                    url: '/auth/login',
                    data: {assertion: assertion},
                    success: function(response, status, xhr) {
console.log(response, status);
                            gravatar = response.gravatar;
                            username = response.username;

                            $('#login_prompt').hide();
                            $('#chat_prompt').show();

                            socket.emit('adduser', username);
                        },
                    error: function(xhr, status, error) {
                            console.log(xhr, status, error);
                        }
                });
            },
        onlogout: function() {
                console.log('========== onlogout');
                $.ajax({
                    type: 'POST',
                    url: '/auth/logout',
                    success: function(response, status, xhr) {
                            console.log(response, status);

                            $('#login_prompt').show();
                            $('#chat_prompt').hide();
                        },
                    error: function(xhr, status, error) {
                            console.log(xhr, status, error);
                        }
                });
            }
    });
}
        $(document).ready(function() {
    
            // on connection to server, ask for user's name with an anonymous callback
            socket.on('connect', function(){
                socket.emit('join', room);
                // call the server-side function 'adduser' and send one parameter (value of prompt)
//                socket.emit('adduser', room, prompt("What's your name?"));
            });
        
            socket.on('snapshot', function(data) {
                $.each(data.candles.S5, function(i, e) {
                    series_data.push([e.time*1000, e['open mid'], e['high mid'], e['low mid'], e['close mid']]);
                });
                // create the chart
                chart = new Highcharts.StockChart({
                   chart : {
                       renderTo : 'chart_container'
                    },

                    rangeSelector : {
                        buttons : [
                        {
                            type : 'minute',
                            count : 10,
                            text : '10m'
                        },
                        {
                            type : 'hour',
                            count : 1,
                            text : '1h'
                        },
                        {
                            type : 'hour',
                            count : 6,
                            text : '6h'
                        },
                        {
                            type : 'day',
                            count : 1,
                            text : '1d'
                        },
                        {
                            type : 'week',
                            count : 1,
                            text : '1w'
                        },
                        {
                            type : 'all',
                            count : 1,
                            text : 'All'
                        }
                        ],
                        selected : 1,
                        inputEnabled : false
                    },
                
                    series : [{
                        type : 'candlestick',
                        name : room.replace('_', '/'),
                        data : series_data
                    }]
                });
            });

            socket.on('candle', function(data) {
                var new_point = [ data.time*1000, data['open mid'], data['high mid'], data['low mid'], data['close mid'] ];
                chart.series[0].addPoint(new_point, true, true);
            });
            // listener, whenever the server emits 'updatechat', this updates the chat body
            socket.on('updatechat', function (data) {
console.log(data);
                var message_class = "alert-chat-message-" + ($("#chat_container").children().length % 2 ? "even" : "odd");
                var new_message = $("<div />")
                    .addClass("alert " + message_class)
                    .css({
                        "margin-bottom": "0.65em"
                    })
                    .html("<strong>" + data.username + ":</strong>&nbsp;&nbsp;" + data.text)
                    .appendTo("#chat_container");
            });
        
            // listener, whenever the server emits 'updateusers', this updates the username list
            socket.on('updateusers', function(data) {
                $("#users").empty();
                $.each(data, function(key, value) {
                    var new_message = $("<div />")
                        .addClass("label label-info")
                        .css({
                            "display": "block",
                            "margin": ".35em 0"
                        })
                        .text(key)
                        .appendTo("#users");
                });
            });

            $('#send_message').click( function() {
                var message = $("#message").val();
console.log('message', message);
                $("#message").val("");
                // tell server to execute 'sendchat' and send along one parameter
                socket.emit("sendchat", message);
            });
            
            // when the client hits ENTER on their keyboard
            $("#message").keypress(function(e) {
                if(e.which == 13) {
                    $(this).blur();
                    $("#send_message").focus().click();
                }
            });
    
            // TODO: add router, Sammy or Backbone
            //router = Sammy(function() {
            //    // profile pages
            //    this.get(/\#\/profile\/(.*)/, function() {
            //        var display_name = this.params['splat'];
            //
            //        var profile_promise = get_profile(display_name);
            //
            //        profile_promise.done(function() {
            //            show_view('profile');
            //        });
            //    });
            //
            //    // leaderboard pages
            //    this.get(/\#\/charts\/(\d+)/, function() {
            //        var currency_pair = this.params['splat'];
            //        show_view('chart');
            //    });
            //
            //});
            //router.run(); 
            
        });

        </script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<!--        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>-->
    </body>
</html>
